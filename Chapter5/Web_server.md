## web server

- 모든 웹서버는 리소스에 대한 http 요청을 받아 데이터를 클라이언트로 반환한다.
- http 프로토콜 구현, 웹 리소스 관리, 웹 서버 관리 기능 제공
- TCP 커넥션 관리에 대한 책임을 운영체제와 나눠 갖는다.

### 다목적 소프트웨어 웹 서버

웹 서버 소프트웨어는 거의 모든 컴퓨터 & 운영체제에서 동작하고 많고 다양한 웹 서버 프로그램이 존재하지만 그 중 몇 가지만이 상용된다.

- 마이크로소프트
- 아파치
- nginx

### 임베디드 웹서버

사용가 end user 용 기기를 간편한 웹 브라우저 인터페이스로 관리할 수 있도록 해준다.
(e.g. 프린터, 가전제품 etc)

## 웹서버가 하는 일

- 커넥션을 맺음: 클라이언트의 접속을 받아들이거나 원치 않는 클라이언트라면 커넥션 끊기
- 요청을 받음: http 요청 메세지를 네트워크로부터 읽기
- 요청을 처리: 요청 메세지를 해석하고 행동을 취하기
- 리소스에 접근: 메세지에서 지정한 리소스에 접근
- 응답 만들기: 올바른 헤더를 포함한 http 응답 매세지 생성
- 응답 보내기: 응답을 클라이언트에 반환
- 트랜잭션을 로그로 남김: 로그파일에 트랜잭션 완료에 대한 기록을 남기기

### 1. 클라이언트 커넥션 수락

- 클라이언트->서버 로 TCP 커넥션을 요청: 서버는 커넥션을 맺고 TCP 커넥션에서 IP 주소를 추출하여 클라이언트 확인.
- 대부분의 웹 서버는 역방향 DNS 로 클라이언트의 IP 주소를 호스트명으로 변환하도록 되어있음. hostname lookup 은 시간이 많이 소요될 수 있고 웹 트랜잭션을 느려지게 할 수 있어 대용량 웹서버는 그 기능을 꺼두거나 특정 데이터에 대해서만 켜놓음

### 2. 요청 메세지 수신

- 요청줄을 파싱하여 메소드, 지정된 리소스의 식별자(URI), 버전 번호를 찾음.
- 메세지 헤더들을 읽음
- 헤더의 끝을 의미하는 CRLF 로 끝나는 빈 줄을 찾음 (있으면)
- 요청 본문이 있다면 읽어들임
- 요청 메세지를 파싱할때 서버는 네트워크로부터 입력 데이터를 불규칙적으로 받는데 커넥션은 언제라도 끊길 수 있기 때문에 메세지 일부분을 메모리에 임시 저장할 필요가 있다.
  ![](https://images.velog.io/images/wltjs10645/post/12013f8e-1048-416f-8b86-ff022b024a20/image.png)

- 몇 몇 웹서버는 요청 메세지를 쉽게 다룰 수 있도록 내부 자료구조에 저장한다. (p.135 참조)
- 커넥션 I/O 처리 아키텍쳐 (p.136 이미지 참조)
  - 단일 스레드 웹 서버: <br>
    한 번에 하나의 요청을 처리한다. 트랜잭션 완료 후 다음 커넥션 처리. 처리 도중 다른 모든 커넥션은 무시되기 때문에 심각한 성능 문제를 발생시킬 수 있음
  - 멀티 프로세스 & 멀티 스레드 웹 서버: <br>
    여러 요청을 동시에 처리하기 위해 여러 개의 프로세스 or 고효율 프로세스를 할당한다.
  - 다중 I/O 서버: <br>
    커넥션의 상태가 바뀌면 그 커넥션에 대해 소량의 처리가 수행되고, 처리 완료 후 커넥션은 다음번 상태 변경을 위해 열린 커넥션 목록으로 돌아간다. 스레드와 프로세스는 유휴 상태의 커넥션에 리소스를 낭비하지 않는다.
  - 다중 멀티 스레드 웹 서버: <br>
    멀티스레딩 + 다중화, 여러 개의 스레드는 각각 열려있는 커넥션을 감시하고 조금씩 작업을 수행

### 3. 요청 처리

### 4. 리소스의 매핑과 접근

- docroot: 요청 URI 를 웹 서버의 파일 시스템 안의 파일 이름으로 사용
- 동적 콘텐츠 리소스 매핑
- Server-Side Includes(SSI): 어떤 리소스가 SSI 로 설정되어 있다면 서버는 그 리소스의 내용을 클라이언트에게 보내기 전에 처리한다(?)
- 접근제어

### 5. 응답 만들기

- 응답 엔터티
  - content-type header (MIME 타입 서술)
  - content-length header
  - contents
- 리다이렉션
  - 리소스가 옮겨진 경우 (permanantly: 301 or temporary: 303 / 307)
  - URL 증강
  - 로드 밸런싱

### 6. 응답 보내기

### 7. 로깅

트랜잭션 완료 후 웹서버는 트랜잭션이 어떻게 수행되었는 지에 대한 로그를 로그 파일에 기록
